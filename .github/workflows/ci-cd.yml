# SGICS - Workflow de CI/CD para GitHub Actions
# Automatiza testing, análisis de código y deployment

name: SGICS CI/CD Pipeline

# Triggers - cuándo se ejecuta el workflow
on:
  # En cada push a ramas principales y features
  push:
    branches: 
      - main              # Producción
      - develop          # Desarrollo
      - 'SCRUM-*'        # Branches de features del proyecto
      - 'feature/*'      # Features adicionales
      - 'hotfix/*'       # Hotfixes de emergencia
  # En cada pull request a main o develop
  pull_request:
    branches: [ main, develop ]
  # Permitir ejecución manual
  workflow_dispatch:

# Variables de entorno globales
env:
  PYTHON_VERSION: "3.12"  # Python 3.14 aún no soportado por Django
  NODE_VERSION: "18"
  
jobs:
  # ==========================================
  # JOB 1: TESTS BACKEND (Django + pytest)
  # ==========================================
  backend-tests:
    name: "Backend Tests"
    runs-on: ubuntu-latest
    
    # Servicios necesarios para los tests
    services:
      # Base de datos MySQL para tests
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test_sgics
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
          MYSQL_ROOT_PASSWORD: test_root_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      # Redis para tests de cache
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    
    steps:
    # Checkout del código
    - name: Checkout código
      uses: actions/checkout@v4
    
    # Configurar Python con caché de pip
    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # Instalar dependencias del backend
    - name: Instalar dependencias Backend
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip install coverage pytest-cov

    
    # Ejecutar migraciones para tests
    - name: Preparar base de datos de prueba
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.development
      run: |
        python manage.py migrate --noinput
    
    # Ejecutar tests con coverage
    - name: Ejecutar tests Backend (pytest)
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.development
      run: |
        coverage run -m pytest -v --tb=short
        coverage xml
        coverage report
    
    # Subir coverage como artifact
    - name: Subir coverage Backend
      uses: actions/upload-artifact@v3
      with:
        name: backend-coverage
        path: backend/coverage.xml
    
    # Health check después de iniciar servidor
    - name: Verificar health endpoints
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.development
      run: |
        # Iniciar servidor en background
        python manage.py runserver 8000 &
        SERVER_PID=$!
        
        # Esperar que el servidor inicie
        sleep 10
        
        # Verificar endpoints de salud
        echo "Verificando /healthz/healthz"
        curl -f http://localhost:8000/healthz/healthz || exit 1
        
        echo "Verificando /healthz/readyz"
        curl -f http://localhost:8000/healthz/readyz || exit 1
        
        echo "Health checks exitosos"
        
        # Terminar servidor
        kill $SERVER_PID

  # ==========================================
  # JOB 2: TESTS FRONTEND (Vue + Vitest)
  # ==========================================
  frontend-tests:
    name: "Frontend Tests"
    runs-on: ubuntu-latest
    
    steps:
    # Checkout del código
    - name: Checkout código
      uses: actions/checkout@v4
    
    # Configurar Node.js con caché de npm
    - name: Configurar Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    # Instalar dependencias del frontend
    - name: Instalar dependencias Frontend
      working-directory: ./frontend
      run: |
        npm ci --prefer-offline --no-audit
    
    # Ejecutar tests del frontend
    - name: Ejecutar tests Frontend (Vitest)
      working-directory: ./frontend
      run: |
        npm run test:coverage
    
    # Subir coverage como artifact
    - name: Subir coverage Frontend
      uses: actions/upload-artifact@v3
      with:
        name: frontend-coverage
        path: frontend/coverage/
    
    # Build para verificar que compila
    - name: Build Frontend
      working-directory: ./frontend
      run: |
        npm run build

  # ==========================================
  # JOB 3: ANÁLISIS DE CALIDAD DE CÓDIGO (Backend)
  # ==========================================
  backend-quality:
    name: "Backend Code Quality"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Instalar herramientas de calidad
      working-directory: ./backend
      run: |
        pip install black safety pylint-django
    
    - name: Verificar formato (Black)
      working-directory: ./backend
      run: |
        black --check .
    
    - name: Verificar vulnerabilidades (Safety)
      working-directory: ./backend
      run: |
        safety check
    
    - name: Análisis estático (Pylint)
      working-directory: ./backend
      run: |
        pylint --load-plugins=pylint_django --django-settings-module=scouts_platform.settings.development .

  # ==========================================
  # JOB 4: ANÁLISIS DE CÓDIGO (SonarQube)
  # ==========================================
  sonar-analysis:
    name: "Análisis SonarQube"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, backend-quality]
    
    steps:
    # Checkout del código
    - name: Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarQube
    
    # Descargar artifacts de coverage
    - name: Descargar coverage Backend
      uses: actions/download-artifact@v3
      with:
        name: backend-coverage
        path: backend/
    
    - name: Descargar coverage Frontend  
      uses: actions/download-artifact@v3
      with:
        name: frontend-coverage
        path: frontend/coverage/
    
    # Ejecutar análisis SonarQube
    - name: Análisis SonarQube
      uses: sonarqube-quality-gate-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================
  # JOB 5: NOTIFICACIONES
  # ==========================================
  notify:
    name: "Notificar Resultado del Pipeline"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, backend-quality]
    if: always()
    
    steps:
    - name: Notificar resultado de tests
      run: |
        if [ "${{ needs.backend-tests.result }}" = "success" ] && [ "${{ needs.frontend-tests.result }}" = "success" ]; then
          echo "Tests completados exitosamente en rama: ${{ github.ref_name }}"
        else
          echo "Tests fallaron en rama: ${{ github.ref_name }}"
          echo "Backend result: ${{ needs.backend-tests.result }}"
          echo "Frontend result: ${{ needs.frontend-tests.result }}"
        fi
